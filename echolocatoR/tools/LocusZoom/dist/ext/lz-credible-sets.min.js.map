{"version":3,"sources":["lz-credible-sets.min.js"],"names":["gwasCredibleSets","Error","l","LocusZoom","ext","Data","CredibleSetLZ","Source","extend","init","this","parseInit","enableCache","dependentSource","prototype","params","fields","log_pvalue","constructor","SOURCE_NAME","threshold","getCacheKey","state","chain","credible_set_threshold","chr","start","end","join","fetchRequest","self","body","nlogpvals","map","item","credset_data","scores","scoring","bayesFactors","posteriorProbabilities","normalizeProbabilities","credibleSet","marking","findCredibleSet","credSetScaled","rescaleCredibleSet","credSetBool","markBoolean","i","length","push","posterior_prob","contrib_fraction","is_member","e","console","error","Q","when","combineChainBody","data","outnames","trans","src","dest","Object","keys","forEach","attr","Layouts","add","get","unnamespaced","html","namespace","assoc","credset","closable","show","or","hide","and","id","ld","fill_opacity","tooltip","type","id_field","x_axis","field","color","filters","behaviors","onmouseover","action","status","onmouseout","onclick","exclusive","onshiftclick","tooltip_positioning","title","text","x","style","font-size","width","height","min_height","proportional_width","margin","top","right","bottom","left","inner_border","dashboard","interaction","drag_background_to_pan","scroll_to_zoom","x_linked","data_layers","components","position","button_html","button_title","layer_name","default_config_display_name","options","display_name","display","point_shape","point_size","scale_function","parameters","field_value","then","else","legend","shape","size","label","class","breaks","values","responsive_resize","min_region_scale","max_region_scale","panels"],"mappings":"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","file":"lz-credible-sets.min.js","sourcesContent":["/*\n    Custom code used to power credible sets demonstration example. This is not part of the core LocusZoom library,\n    but can be included as a standalone file.\n\n    The page must incorporate and load all libraries before this file can be used, including:\n     - Vendor assets\n     - LocusZoom\n     - gwas-credible-sets (available via NPM or a related CDN)\n*/\n'use strict';\n\n/* global gwasCredibleSets, LocusZoom, Q */\n\nif (typeof gwasCredibleSets === 'undefined') {\n    throw new Error('The standalone gwas-credible-sets library is required to use this extension');\n}\n\n!function() {\n    if (!LocusZoom.ext.Data) {\n        LocusZoom.ext.Data = {};\n    }\n\n    /**\n     * Custom data source that calculates the 95% credible set based on provided data.\n     * This source must be requested as the second step in a chain, after a previous step that returns fields required\n     *  for the calculation.\n     *\n     * @param {Object} init.params\n     * @param {Object} init.params.fields\n     * @param {String} init.params.fields.log_pvalue The name of the field containing pvalue information\n     * @param {Number} [init.params.threshold=0.95] The credible set threshold (eg 95%)\n     *\n     * @class\n     * @public\n     * @augments LocusZoom.Data.Source\n     */\n    LocusZoom.ext.Data.CredibleSetLZ = LocusZoom.Data.Source.extend(function(init) {\n        this.parseInit(init);\n        this.enableCache = true;\n        this.dependentSource = true; // Don't do calcs for a region with no assoc data\n    }, 'CredibleSetLZ');\n\n    LocusZoom.ext.Data.CredibleSetLZ.prototype.parseInit = function (init) {\n        this.params = init.params;\n        if (!(this.params.fields && this.params.fields.log_pvalue)) {\n            throw new Error('Source config for ' + this.constructor.SOURCE_NAME + \" must specify how to find 'fields.log_pvalue'\");\n        }\n        if (!this.params.threshold) {\n            this.params.threshold = 0.95;\n        }\n    };\n\n    LocusZoom.ext.Data.CredibleSetLZ.prototype.getCacheKey = function(state, chain, fields) {\n        var threshold = state.credible_set_threshold || this.params.threshold;\n        return [ threshold, state.chr, state.start, state.end ].join('_');\n    };\n\n    LocusZoom.ext.Data.CredibleSetLZ.prototype.fetchRequest = function (state, chain) {\n        var self = this;\n        // The threshold can be overridden dynamically via `plot.state`, or set when the source is created\n        var threshold = state.credible_set_threshold || this.params.threshold;\n        // Calculate raw bayes factors and posterior probabilities based on information returned from the API\n        if (!chain.body[0][self.params.fields.log_pvalue]) {\n            throw new Error('Credible set source could not locate the required fields from a previous request.');\n        }\n        var nlogpvals = chain.body.map(function (item) { return item[self.params.fields.log_pvalue]; });\n        var credset_data = [];\n        try {\n            var scores = gwasCredibleSets.scoring.bayesFactors(nlogpvals);\n            var posteriorProbabilities = gwasCredibleSets.scoring.normalizeProbabilities(scores);\n\n            // Use scores to mark the credible set in various ways (depending on your visualization preferences,\n            //   some of these may not be needed)\n            var credibleSet = gwasCredibleSets.marking.findCredibleSet(scores, threshold);\n            var credSetScaled = gwasCredibleSets.marking.rescaleCredibleSet(credibleSet);\n            var credSetBool = gwasCredibleSets.marking.markBoolean(credibleSet);\n\n            // Annotate each response record based on credible set membership\n            for (var i = 0; i < chain.body.length; i++) {\n                credset_data.push({\n                    posterior_prob: posteriorProbabilities[i],\n                    contrib_fraction: credSetScaled[i],\n                    is_member: credSetBool[i]\n                });\n            }\n        } catch (e) {\n            // If the calculation cannot be completed, return the data without annotation fields\n            console.error(e);\n        }\n        return Q.when(credset_data);\n    };\n\n    LocusZoom.ext.Data.CredibleSetLZ.prototype.combineChainBody = function (data, chain, fields, outnames, trans) {\n        // At this point namespacing has been applied; add the calculated fields for this source to the chain\n        for (var i = 0; i < data.length ; i++) {\n            var src = data[i];\n            var dest = chain.body[i];\n            Object.keys(src).forEach(function(attr) { dest[attr] = src[attr]; });\n        }\n        return chain.body;\n    };\n\n    // Add related layouts to the central global registry\n    LocusZoom.Layouts.add('tooltip', 'association_credible_set', function () {\n        // Extend a known tooltip with an extra row of info showing posterior probabilities\n        var l = LocusZoom.Layouts.get('tooltip', 'standard_association', { unnamespaced: true });\n        l.html += '<br>Posterior probability: <strong>{{{{namespace[credset]}}posterior_prob|scinotation}}</strong>';\n        return l;\n    }());\n\n    LocusZoom.Layouts.add('tooltip', 'annotation_credible_set', {\n        namespace: { 'assoc': 'assoc', 'credset': 'credset' },\n        closable: true,\n        show: {or: ['highlighted', 'selected']},\n        hide: {and: ['unhighlighted', 'unselected']},\n        html: '<strong>{{{{namespace[assoc]}}variant}}</strong><br>'\n        + 'P Value: <strong>{{{{namespace[assoc]}}log_pvalue|logtoscinotation}}</strong><br>' +\n        '<br>Posterior probability: <strong>{{{{namespace[credset]}}posterior_prob|scinotation}}</strong>'\n    });\n\n    LocusZoom.Layouts.add('data_layer', 'association_credible_set', function () {\n        return LocusZoom.Layouts.get('data_layer', 'association_pvalues', {\n            unnamespaced: true,\n            id: 'associationcredibleset',\n            namespace: { 'assoc': 'assoc', 'credset': 'credset', 'ld': 'ld' },\n            fill_opacity: 0.7,\n            tooltip: LocusZoom.Layouts.get('tooltip', 'association_credible_set', { unnamespaced: true }),\n            fields: [\n                '{{namespace[assoc]}}variant', '{{namespace[assoc]}}position',\n                '{{namespace[assoc]}}log_pvalue', '{{namespace[assoc]}}log_pvalue|logtoscinotation',\n                '{{namespace[assoc]}}ref_allele',\n                '{{namespace[credset]}}posterior_prob', '{{namespace[credset]}}contrib_fraction',\n                '{{namespace[credset]}}is_member',\n                '{{namespace[ld]}}state', '{{namespace[ld]}}isrefvar'\n            ]\n        });\n    }());\n\n    LocusZoom.Layouts.add('data_layer', 'annotation_credible_set', {\n        namespace: { 'assoc': 'assoc', 'credset': 'credset' },\n        id: 'annotationcredibleset',\n        type: 'annotation_track',\n        id_field: '{{namespace[assoc]}}variant',\n        x_axis: {\n            field: '{{namespace[assoc]}}position'\n        },\n        color: '#00CC00',\n        fields: ['{{namespace[assoc]}}variant', '{{namespace[assoc]}}position', '{{namespace[assoc]}}log_pvalue', '{{namespace[credset]}}posterior_prob', '{{namespace[credset]}}contrib_fraction', '{{namespace[credset]}}is_member'],\n        filters: [\n            // Specify which points to show on the track. Any selection must satisfy ALL filters\n            ['{{namespace[credset]}}is_member', true]\n        ],\n        behaviors: {\n            onmouseover: [\n                {action: 'set', status: 'highlighted'}\n            ],\n            onmouseout: [\n                {action: 'unset', status: 'highlighted'}\n            ],\n            onclick: [\n                {action: 'toggle', status: 'selected', exclusive: true}\n            ],\n            onshiftclick: [\n                {action: 'toggle', status: 'selected'}\n            ]\n        },\n        tooltip: LocusZoom.Layouts.get('tooltip', 'annotation_credible_set', { unnamespaced: true }),\n        tooltip_positioning: 'top'\n    });\n\n    LocusZoom.Layouts.add('panel', 'annotation_credible_set', {\n        id: 'annotationcredibleset',\n        title: { text: 'SNPs in 95% credible set', x:50, style: { 'font-size': '14px' } },\n        width: 800,\n        height: 100,\n        min_height: 100,\n        proportional_width: 1,\n        margin: {top: 35, right: 50, bottom: 40, left: 50},\n        inner_border: 'rgb(210, 210, 210)',\n        dashboard: LocusZoom.Layouts.get('dashboard', 'standard_panel', { unnamespaced: true }),\n        interaction: {\n            drag_background_to_pan: true,\n            scroll_to_zoom: true,\n            x_linked: true\n        },\n        data_layers: [\n            LocusZoom.Layouts.get('data_layer', 'annotation_credible_set', {unnamespaced: true})\n        ]\n    });\n\n    LocusZoom.Layouts.add('panel', 'association_credible_set', function() {\n        var l = LocusZoom.Layouts.get('panel', 'association', {\n            unnamespaced: true,\n            id: 'associationcrediblesets',\n            namespace: { 'assoc': 'assoc', 'credset': 'credset' },\n            data_layers: [\n                LocusZoom.Layouts.get('data_layer', 'significance', { unnamespaced: true }),\n                LocusZoom.Layouts.get('data_layer', 'recomb_rate', { unnamespaced: true }),\n                LocusZoom.Layouts.get('data_layer', 'association_credible_set', { unnamespaced: true })\n            ]\n        });\n        // Add \"display options\" button to control how credible set coloring is overlaid on the standard association plot\n        l.dashboard.components.push(\n            {\n                type: 'display_options',\n                position: 'right',\n                color: 'blue',\n                // Below: special config specific to this widget\n                button_html: 'Display options...',\n                button_title: 'Control how plot items are displayed',\n                layer_name: 'associationcredibleset',\n                default_config_display_name: 'Linkage Disequilibrium (default)', // display name for the default plot color option (allow user to revert to plot defaults)\n\n                options: [\n                    {\n                        // First dropdown menu item\n                        display_name: '95% credible set (boolean)',  // Human readable representation of field name\n                        display: {  // Specify layout directives that control display of the plot for this option\n                            point_shape: 'circle',\n                            point_size: 40,\n                            color: {\n                                field: '{{namespace[credset]}}is_member',\n                                scale_function: 'if',\n                                parameters: {\n                                    field_value: true,\n                                    then: '#00CC00',\n                                    else: '#CCCCCC'\n                                }\n                            },\n                            legend: [ // Tells the legend how to represent this display option\n                                { shape: 'circle', color: '#00CC00', size: 40, label: 'In credible set', class: 'lz-data_layer-scatter' },\n                                { shape: 'circle', color: '#CCCCCC', size: 40, label: 'Not in credible set', class: 'lz-data_layer-scatter' }\n                            ]\n                        }\n                    },\n                    {\n                        // Second option. The same plot- or even the same field- can be colored in more than one way.\n                        display_name: '95% credible set (gradient by contribution)',\n                        display: {\n                            point_shape: 'circle',\n                            point_size: 40,\n                            color: [\n                                {\n                                    field: '{{namespace[credset]}}contrib_fraction',\n                                    scale_function: 'if',\n                                    parameters: {\n                                        field_value: 0,\n                                        then: '#777777'\n                                    }\n                                },\n                                {\n                                    scale_function: 'interpolate',\n                                    field: '{{namespace[credset]}}contrib_fraction',\n                                    parameters: {\n                                        breaks: [0, 1],\n                                        values: ['#fafe87', '#9c0000']\n                                    }\n                                }\n                            ],\n                            legend: [\n                                { shape: 'circle', color: '#777777', size: 40, label: 'No contribution', class: 'lz-data_layer-scatter' },\n                                { shape: 'circle', color: '#fafe87', size: 40, label: 'Some contribution', class: 'lz-data_layer-scatter' },\n                                { shape: 'circle', color: '#9c0000', size: 40, label: 'Most contribution', class: 'lz-data_layer-scatter' }\n                            ]\n                        }\n                    }\n                ]\n            }\n        );\n        return l;\n    } ());\n\n    LocusZoom.Layouts.add('plot', 'association_credible_set', {\n        state: {},\n        width: 800,\n        height: 450,\n        responsive_resize: 'both',\n        min_region_scale: 20000,\n        max_region_scale: 1000000,\n        dashboard: LocusZoom.Layouts.get('dashboard', 'standard_plot', {unnamespaced: true}),\n        panels: [\n            LocusZoom.Layouts.get('panel', 'association_credible_set', {unnamespaced: true}),\n            LocusZoom.Layouts.get('panel', 'annotation_credible_set', {unnamespaced: true}),\n            LocusZoom.Layouts.get('panel', 'genes', { unnamespaced: true })\n        ]\n    });\n}();\n"]}